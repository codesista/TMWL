<?php 
$themes = array(
	array(
	  'name' => 'Postcard 7',
	  'path' => 'postcard7.jpg',
	  'type' => 'background',
	  'id' => 7,
	  'html' => '<div id=\"postcard_bg\">"+
	  			"<img id=\"theme_bg\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/7-img-placeholder.jpg\">"+
				"<img id=\"theme_bg_pic\" style=\"left:0px;top:0px;height:356px;width:534px;\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/7-img-placeholder.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard7\"></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	  array(
	  'name' => 'Postcard 8',
	  'path' => 'postcard8.jpg',
	  'type' => 'background',
	  'id' => 8,
	  'html' => '<div id=\"postcard_bg\">"+
	  			"<img id=\"theme_bg\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard8.jpg\">"+
				"<img id=\"theme_bg_pic\" style=\"left:271px;top:12px;height:300px;width:250px;\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/8-img-placeholder.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard8\"></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard1.jpg',
	  'type' => 'background',
	  'id' => 1,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"theme_bg\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard1.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard1\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard2.jpg',
	  'type' => 'avatar',
	  'id' => 2,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard2.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard2\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard3.jpg',
	  'type' => 'avatar',
	  'id' => 3,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard3.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard3\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard4.jpg',
	  'type' => 'avatar',
	  'id' => 4,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard4.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard4\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  ),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard5.jpg',
	  'type' => 'avatar',
	  'id' => 5,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard5.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard5\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>' 
	),
	array(
	  'name' => 'Serenity',
	  'path' => 'postcard6.jpg',
	  'type' => 'avatar',
	  'id' => 6,
	  'html' => '<div id=\"postcard_bg\">"+
				"<img id=\"\" alt=\"theme background\" src=\"'.site_url() . 'images/postcards/postcard6.jpg\">"+
				"<div style=\"left: 49px; top: 263px;\" id=\"postcard_avatar\"> "+
				"<img height=\"73px\" width=\"73px\" id=\"avatar_image\" alt=\"avatar image\" src=\"\">"+
				"</div>"+
				"<div id=\"postcard_text\" class=\"postcard6\" ></div>"+
				"<div id=\"postcard_sender_name\">"+
				"<a href=\"http://www.'.@Users::user()->oauth_provider.'.com/'.@Users::user()->username.'\" target=\"_blank\">\@'.@Users::user()->username.'</a>"+
				"</div>"+
				"</div>'
	  )
);

if(!Users::user()):
// show modal window to login using fb or twitter
?>
<script type="text/javascript">
$(function(){
  $('#dialog').dialog({
    closeOnEscape : false,
    draggable : false,
    modal : true,
    resizable : false,
    width : 500,
    title : 'Login & give thanks',
    position : ['center', 100],
    show : 'fade',
    autoOpen: true,
    hide : 'fade',
    open: function(){
				$('.ui-dialog-titlebar-close').remove();
    		}
  });
});
</script>
<?php endif;?>
<script type="text/javascript">
$(function(){
	var themes = new Array();
	  <?php foreach($themes as $theme):?>
	  themes[<?php echo $theme['id']; ?>] = "<?php echo $theme['html'];?>";
	  <?php endforeach;?>


	  $('#help-text').dialog({
	      closeOnEscape : true,
	      draggable : false,
	      modal : true,
	      resizable : false,
	      width : 600,
	      title : $(this).attr('title'),
	      position : ['center', 100],
	      show : 'fade',
	      autoOpen: false,
	      hide : 'fade',
	      buttons : {
	  	      'Close' : function(){
	  	        $('#help-text').dialog('close');
	  	      }
	  	    }
	    });
  
	$('.theme_option').live('click',function(e){
		var id = $(this).attr('id');
		$('#postcard_preview').html(themes[id]);
	    $('#postcard_text').html($('#input_message').val().replace(/[<>]/g,''));
	    $('.theme_option').removeClass('current');
	    $('input[name=theme_id]').val(id);
	    $('input[name=selected_theme_id]').val(id);
	    $(this).addClass('current');
	    $('input[name=postcard_html]').val($('#postcard_preview').html());
	
	    if(Math.abs(id) > 6){
			$('#background_image_options').slideDown();
		}else
			$('#background_image_options').slideUp();
	    updateAvatar();
	    updateBackgroundImg();
	});

  // populate default theme
  <?php if($this->session->userdata('postcard_state')):?>
  	$('#input_message').val($('#postcard_text').html());
  	$('#<?php echo $this->session->userdata('theme_id'); ?>').addClass('current');
  	<?php if($this->session->userdata('theme_id') > 6):?>
		$('#background_image_options').slideDown();
	<?php endif;
	else:?>
  	$('#postcard_preview').html(themes[5]);
  	$('#5').addClass('current');
  	$('input[name=theme_id]').val('5');
  	$('#background_image_options').slideUp();
  <?php endif;?>
  
  if($('input[name=use_twitter]').val() == "yes" ){
	  $("#use_avatar").attr('checked','checked');
  }
  
  updateAvatar();
  updateBackgroundImg();
  
  $('input[name=postcard_html]').val($('#postcard_preview').html());
  
  $('#use_avatar').click(function(){
    updateAvatar();
  });

  var max_chars = 140;
   
  $('#input_message').keyup(function(){
    $('#postcard_text').html($(this).val().replace(/[<>]/g,''));
    var str = $(this).val();
    var len = str.length;
    
    if(len > max_chars){
        str = str.substring(0,max_chars);
        $(this).val(str);
    }
    len = str.length;
    $('#char-count').html(max_chars - len);
    $('input[name=input_message_text]').val($(this).val());
  });

  $('#next-button').click(function(e){
	$('input[name=postcard_html]').val($('#postcard_preview').html());
  });
  
  $('#upload-button').click(function(e){
	  if(!$('input[name=userfile]').val()){
		  alert('Please select an image to upload');
		  $('input[name=userfile]').focus();
		  return false;
	  }
	$('input[name=postcard_html]').val($('#postcard_preview').html());
  });

  
  $('#why-upload, #why-imgurl').click(function(e){
		e.preventDefault();
	  var id = $(this).attr('id');
	  
	  if(id=="why-upload"){
		  $('#url-help').hide();
		  $('#upload-help').show();
	  }
	  else if(id == "why-imgurl"){
		  $('#url-help').show();
		  $('#upload-help').hide();
	  }
	  
	  $('#help-text').dialog('open');
  });
  
  $('input[name=image_url]').change(function(e){
	  updateBackgroundImg();    
	});
	$('#clear-url').click(function(e){ 
		e.preventDefault();
		$('input[name=image_url]').val('');
		updateBackgroundImg(); 
	});

	<?php if($this->session->userdata('share_msg') && Users::user()):?>
		$('#postcard_text').html('<?php echo $this->session->userdata('share_msg');?>');
	<?php endif;?>

	$('#next-button').click(function(e){
		if($('#input_message').val() == ""){
			alert('Please enter a message for your card!');
			$('#input_message').focus();
			return false;
		}else
			return true;
		
	});
});


var updateBackgroundImg = function(){
	var img = $('input[name=postcard_img]').val();
	var url = $('input[name=image_url]').val();
	if(url){
		var file_ext = url.substring(url.lastIndexOf("."));
		if(!(file_ext == '.jpg') && !(file_ext == '.jpeg') && !(file_ext == '.gif') && !(file_ext == '.png')) {
			   alert("URL is not a valid image source. Please check. Only");
			   return false;
		}
		$('#theme_bg_pic').attr("src", url);
		return;
	}
	if(img){
		// that means user uploaded a pic, put it in the theme.
		$('#theme_bg_pic').attr("src", "<?php echo site_url();?>images/uploads/" + img);
		return; 
	}

	if(!img && !url){
		$('#theme_bg_pic').attr("src", "");
		return;
	}
};

var updateAvatar = function(){
  if($("#use_avatar").is(':checked')){
    var img = $('#use_avatar').val();
    $('#postcard_avatar > img').fadeOut();
    $('#postcard_avatar > img').attr('src', img);
    $('#postcard_avatar > img').fadeIn();
    $('input[name=use_twitter]').val('yes');
    $('input[name=selected_use_twitter]').val('yes');
  }else{
    $('#postcard_avatar > img').fadeOut();
    $('input[name=use_twitter]').val('no');
    $('input[name=selected_use_twitter]').val('no');
  }
};
</script>

<div id="help-text" style="display:none">
	<div id="upload-help">
		Upload a photo from your computer that makes your heart swell with gratitude. <br/><br/>
		Your photo will appear as the background image  of your personalized thank you note. <br/><br/>
		(Max file size: 1mb | File Types: .jpg, .jpeg, .gif, .png)
	</div>
	<div id="url-help">
		Enter the full URL of a photo that makes your heart swell with gratitude.  Your photo will appear as the background image of your personalized thank you note.  To get the URL of an image on the web, right click &amp; select "Copy Image URL".  File url must end in .jpg, .jpeg, .gif or .png.
		<br/><br/>
		Examples:<br/>
		<strong>from flickr: </strong><br/>
		http://farm4.static.flickr.com/3341/3237043693_1ca2635ae4.jpg<br/><br/>
		<strong>from facebook: </strong>
		<br/>
		http://sphotos.ak.fbcdn.net/hphotos-ak-ash2/hs496.ash2/76952_1612769751623_1007641623_31717404_6193227_n.jpg<br/>
	</div>
</div>

<div id="dialog" style="display:none;">
	<p>Log in via twitter or facebook to create a custom thank you note that shares your grateful heart with the world.</p>
	<br/>
	<div style="margin:auto">
		<div style="margin:5px;float:left;clear:both;margin-left:70px">
			<a href="<?php echo site_url() . 'user/twitter_login'; ?>"><img src="<?php echo site_url() . 'images/sign-in-with-twitter-l.png'; ?>" alt="twitter login" /></a>
		</div>
		<div style="margin:5px;float:left;clear:none;">
			<a href="<?php echo site_url() . 'user/facebook_login'; ?>"><img src="<?php echo site_url() . 'images/fb_login-button.png'; ?>" alt="facebook login" /></a>
		</div>
		  <?php $this->session->set_userdata('return_url', 'postcard/design');?>
	 </div>
</div>
<div class="page_content">
  <div id ="create_note">
    Create a thank you note
  </div>
  <div id="create_card" class="postcard_block">
    <div class="select_card">Select a theme</div>
        <div id="postcard_preview">
        <?php if($this->session->userdata('postcard_state'))
        		echo $this->session->userdata('postcard_state');
        ?>
	  	</div>
      <div id="theme_options">
        <?php 
      $i = 1; // counter for radio buttons
      foreach($themes as $theme){

        $data = array(
          'name'        => 'theme',
          'id'          => $theme['type'] . '-' . $i,
          //'class'		  => 'theme_option',
          'value'       => $theme['id'],
          'style'       => 'margin:10px',
          );
        //echo '<div class="each_theme"><span class="theme_radio">' . form_radio($data) . '</span>';
        echo '<div class="each_theme"><img id="'.$theme['id'].'" class="theme_option ' . $theme['type'].'" src="' . site_url() . 'images/postcards/'.$theme['path'] .'" alt="'. $theme['name'] . '" width="120"/></div>';
      }
      ?>
    </div>
    <br/><br/>
    <div id = "message_avatar">
    <br/>
      <div class="avatar">
        <?php if(Users::user()):?>
          <input type="hidden" name="user_id" value="<?php echo Users::user()->user_id;?>"/>
          <input type="checkbox" value="<?php echo Users::user()->profile_avatar;?>" id="use_avatar" checked="checked"/> Use my <?php echo Users::user()->oauth_provider;?> profile avatar
        <?php endif; ?>
        <br/>
        <br/>
      </div>
       <div>
          <p style="margin:0 0 8px 0;width=:200px;float:left;">Message:</p><p style="float:right">Characters left: <span id="char-count">140</span></p>
          <br/>
          <textarea cols="32" rows="10" id="input_message" style="clear:both"><?php if($this->session->userdata('share_msg') && Users::user()){ echo $this->session->userdata('share_msg'); $this->session->unset_userdata('share_msg');}?></textarea>
        </div>
        <?php if($this->session->flashdata('notification')) { ?>
			<div class="notification ui-state-highlight" style="color:#000066;">
				<span class="ui-icon ui-icon-info">&nbsp;</span>&nbsp;<?php echo $this->session->flashdata('notification'); ?>
			</div>
		<?php } ?>		
		<?php if($this->session->flashdata('error')) { ?>
			<div class="notification ui-state-error" style="color:#aa0000;">
				<span class="ui-icon ui-icon-info">&nbsp;</span>&nbsp;<?php echo $this->session->flashdata('error'); ?>
			</div>
		<?php } ?>
      <div id="background_image_options">
        <p style="margin:0 0 15px 0;">Enter Your Custom Background Image:</p>
        <div id="upload_a_back">
	        <form action="<?php echo site_url() . 'postcard/upload'?>" method="post" enctype="multipart/form-data">
		        Upload an image <a href="" id="why-upload" title="Why upload an image?">?</a>&nbsp;:
		        <br/>
		        <input type="file" name="userfile" id="file-upload" class="styled"/><br/>
		        <span style="font-size:12px;">Max size: 1mb<br/>
		        Types: .jpg, .jpeg, .gif, .png</span><br/>
	       		<input type="submit" name="upload pic" value="Preview" id="upload-button" style="margin-top:6px;clear:both;"/>
	           <!-- <p style="font-size:0.8em;clear:both;margin-top:3px;">(Max file size: 1mb | File Types: .jpg, .jpeg, .gif, .png | Max dimensions: 800px by 600px)</p> -->
	           <?php //if($this->session->userdata('img_file')):?>
		        	<input type="hidden" value="<?php echo htmlentities($this->session->userdata('postcard_state'));?>" name="postcard_html"/>
	       			<input type="hidden" name="theme_id" value="<?php echo $this->session->userdata('theme_id');?>"/>
	       			<input type="hidden" name="post_id" value="<?php echo $this->session->userdata('post_id');?>"/>
		        	<input type="hidden" name="postcard_img" value="<?php echo $this->session->userdata('img_file');?>"/>
		        	<input type="hidden" name="use_twitter" value="<?php echo $this->session->userdata('use_twitter');?>"/>
	       			<!-- <img src="<?php echo site_url() . 'images/uploads/' . $this->session->userdata('img_file');?>" alt="" id="custom_img_url" height="200px" width="200px"/>  -->
	       		<?php //endif; ?>
	       </form>
       </div>
       <div id="upload_url">
	    Add from a web URL <a href="" id="why-imgurl" title="Why enter a URL?">?</a>&nbsp;:
	    <br/>
	    <input type="text" name="image_url" id="web_img" style="width:200px;"/> 
	    <br/><br/>
	    <input type="submit" name = "preview" value="Preview" style="margin-top:12px"/>
	    <!-- <a href="#" class="button" title="clear web URL" id="clear-url" style="clear:none;float:right;"><span class="ui-icon ui-icon-minus">&nbsp;</span></a> -->
      </div>
      </div>
      <br/>
     
    </div>
	<div class="clear"></div>
    <form action="<?php echo site_url() . '/postcard/design/do'?>" method="post">
    	<?php if($this->session->userdata('post_id')):?>
       		<input type="hidden" name="post_id" value="<?php echo $this->session->userdata('post_id')?>"/>
       	<?php endif; ?>
       	<input type="hidden" value="" name="input_message_text"/>
       	<input type="hidden" value="" name="selected_theme_id"/>
       	<input type="hidden" value="" name="selected_use_twitter"/>
       	<input type="hidden" value="" name="postcard_html"/>
		<div id="next_button">
    	<input type="submit" name="next" value="next" id="next-button"/>
    </div>
  </form>
</div>	
</div>